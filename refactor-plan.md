# NixOS Configuration Refactoring Plan                                                                                                                                                                            
                                                                                                                                                                                                                   
 ## Overview                                                                                                                                                                                                       
                                                                                                                                                                                                                   
 This document describes the refactoring implemented to reduce repetition, improve maintainability, and introduce more advanced NixOS patterns to this configuration repository.                                   
                                                                                                                                                                                                                   
 ---                                                                                                                                                                                                               
                                                                                                                                                                                                                   
 ## Phase 1 - Foundation                                                                                                                                                                                           
                                                                                                                                                                                                                   
 ### 1.1 Custom Library (`lib/default.nix`)                                                                                                                                                                        
                                                                                                                                                                                                                   
 **Problem**: Repetitive patterns (GitHub SSH key fetching, host configuration boilerplate, user definitions)                                                                                                      
                                                                                                                                                                                                                   
 **Solution**: Created `lib/default.nix` with helper functions.                                                                                                                                                    
                                                                                                                                                                                                                   
 **Changes Made**:                                                                                                                                                                                                 
 - Created `lib/default.nix` with the following helpers:                                                                                                                                                           
   - `fetchGitHubKeys` - Fetch SSH public keys from a GitHub username                                                                                                                                              
   - `mkUser` - Standardized user configuration builder with options for groups, shell, passwords, and SSH keys                                                                                                    
   - `mkHost` - Standardized NixOS host configuration builder with Home Manager integration                                                                                                                        
   - `scanPaths` - Recursively scan a directory and return all `.nix` file paths                                                                                                                                   
   - `importModules` - Import all modules from a directory for use in `imports = [...]`                                                                                                                            
   - `mkFeatureOption` - Create a feature flag option with consistent description format                                                                                                                           
   - `recursiveMerge` - Deep merge multiple attribute sets                                                                                                                                                         
                                                                                                                                                                                                                   
 **Usage Example**:                                                                                                                                                                                                
 ```nix                                                                                                                                                                                                            
 # In flake.nix                                                                                                                                                                                                    
 lib = import ./lib { inherit (nixpkgs) lib; pkgs = ...; inherit inputs; };                                                                                                                                        
                                                                                                                                                                                                                   
 # Using mkUser                                                                                                                                                                                                    
 myLib.mkUser {                                                                                                                                                                                                    
   username = "john";                                                                                                                                                                                              
   extraGroups = ["wheel" "docker"];                                                                                                                                                                               
   githubUsername = "johnnyfleet";                                                                                                                                                                                 
   sshKeysSha256 = "sha256-...";                                                                                                                                                                                   
 }                                                                                                                                                                                                                 
 ```                                                                                                                                                                                                               
                                                                                                                                                                                                                   
 ---                                                                                                                                                                                                               
                                                                                                                                                                                                                   
 ### 1.2 Overlays Directory (`overlays/`)                                                                                                                                                                          
                                                                                                                                                                                                                   
 **Problem**: Overlays defined inline in `hosts/john-laptop/default.nix`, making them hard to reuse and maintain.                                                                                                  
                                                                                                                                                                                                                   
 **Solution**: Extracted overlays to dedicated files in `overlays/` directory.                                                                                                                                     
                                                                                                                                                                                                                   
 **Changes Made**:                                                                                                                                                                                                 
 - Created `overlays/default.nix` - Aggregator that exports all overlays                                                                                                                                           
 - Created `overlays/tailscale.nix` - Skips failing tests (`doCheck = false`)                                                                                                                                      
 - Created `overlays/easytag.nix` - Fixes id3lib detection with configure flags                                                                                                                                    
 - Updated `hosts/john-laptop/default.nix` to import from overlays directory                                                                                                                                       
 - Added `overlays` output to `flake.nix` for external use                                                                                                                                                         
                                                                                                                                                                                                                   
 **Usage Example**:                                                                                                                                                                                                
 ```nix                                                                                                                                                                                                            
 # In host configuration                                                                                                                                                                                           
 nixpkgs.overlays = [ (import ../../overlays).default ];                                                                                                                                                           
                                                                                                                                                                                                                   
 # Or selectively                                                                                                                                                                                                  
 nixpkgs.overlays = [                                                                                                                                                                                              
   (import ../../overlays).tailscale                                                                                                                                                                               
   (import ../../overlays).easytag                                                                                                                                                                                 
 ];                                                                                                                                                                                                                
 ```                                                                                                                                                                                                               
                                                                                                                                                                                                                   
 ---                                                                                                                                                                                                               
                                                                                                                                                                                                                   
 ### 1.3 Development Shell (`devShells`)                                                                                                                                                                           
                                                                                                                                                                                                                   
 **Problem**: No standardized development environment with linting and formatting tools.                                                                                                                           
                                                                                                                                                                                                                   
 **Solution**: Added `devShells` output to `flake.nix` with all necessary tools.                                                                                                                                   
                                                                                                                                                                                                                   
 **Changes Made**:                                                                                                                                                                                                 
 - Added `devShells.x86_64-linux.default` to `flake.nix` containing:                                                                                                                                               
   - `alejandra` - Nix formatter                                                                                                                                                                                   
   - `statix` - Nix linter                                                                                                                                                                                         
   - `deadnix` - Find dead/unused code                                                                                                                                                                             
   - `nix-tree` - Visualize Nix dependencies                                                                                                                                                                       
   - `pre-commit` - Git hooks framework                                                                                                                                                                            
   - `sops` and `age` - Secrets management                                                                                                                                                                         
   - `nil` - Nix LSP for editor integration                                                                                                                                                                        
                                                                                                                                                                                                                   
 **Usage**:                                                                                                                                                                                                        
 ```bash                                                                                                                                                                                                           
 # Enter development shell                                                                                                                                                                                         
 nix develop                                                                                                                                                                                                       
                                                                                                                                                                                                                   
 # Available commands shown on entry:                                                                                                                                                                              
 #   nix fmt        - Format all Nix files                                                                                                                                                                         
 #   statix check   - Lint Nix files                                                                                                                                                                               
 #   deadnix        - Find dead code                                                                                                                                                                               
 #   nix flake check - Verify flake                                                                                                                                                                                
 ```                                                                                                                                                                                                               
                                                                                                                                                                                                                   
 ---                                                                                                                                                                                                               
                                                                                                                                                                                                                   
 ### 1.4 Pre-commit Hooks (`.pre-commit-config.yaml`)                                                                                                                                                              
                                                                                                                                                                                                                   
 **Problem**: No automated checks before commits to catch formatting and linting issues.                                                                                                                           
                                                                                                                                                                                                                   
 **Solution**: Created `.pre-commit-config.yaml` with hooks for Nix tooling.                                                                                                                                       
                                                                                                                                                                                                                   
 **Changes Made**:                                                                                                                                                                                                 
 - Created `.pre-commit-config.yaml` with hooks:                                                                                                                                                                   
   - `alejandra` - Format Nix files on commit                                                                                                                                                                      
   - `statix` - Lint Nix files for anti-patterns                                                                                                                                                                   
   - `deadnix` - Fail if dead code is found                                                                                                                                                                        
   - Standard hooks: trailing-whitespace, end-of-file-fixer, check-yaml, check-added-large-files                                                                                                                   
                                                                                                                                                                                                                   
 **Usage**:                                                                                                                                                                                                        
 ```bash                                                                                                                                                                                                           
 # Install hooks (run once)                                                                                                                                                                                        
 nix develop -c pre-commit install                                                                                                                                                                                 
                                                                                                                                                                                                                   
 # Hooks run automatically on git commit                                                                                                                                                                           
 # Or run manually:                                                                                                                                                                                                
 pre-commit run --all-files                                                                                                                                                                                        
 ```                                                                                                                                                                                                               
                                                                                                                                                                                                                   
 ---                                                                                                                                                                                                               
                                                                                                                                                                                                                   
 ## Phase 2 - Module System                                                                                                                                                                                        
                                                                                                                                                                                                                   
 ### 2.1 Convert `docker.nix` to mkEnableOption Pattern                                                                                                                                                            
                                                                                                                                                                                                                   
 **Problem**: Hardcoded user "john" in module, no way to configure options.                                                                                                                                        
                                                                                                                                                                                                                   
 **Solution**: Converted to proper NixOS module with options.                                                                                                                                                      
                                                                                                                                                                                                                   
 **Changes Made**:                                                                                                                                                                                                 
 - Added `options.modules.docker` with:                                                                                                                                                                            
   - `enable` - mkEnableOption to enable/disable Docker                                                                                                                                                            
   - `users` - List of users to add to docker group                                                                                                                                                                
   - `enableOnBoot` - Whether to start Docker on boot (default: true)                                                                                                                                              
   - `rootless` - Enable rootless Docker mode (default: false)                                                                                                                                                     
 - Wrapped config in `mkIf cfg.enable`                                                                                                                                                                             
 - Users dynamically added to docker group via `genAttrs`                                                                                                                                                          
                                                                                                                                                                                                                   
 **Usage**:                                                                                                                                                                                                        
 ```nix                                                                                                                                                                                                            
 modules.docker = {                                                                                                                                                                                                
   enable = true;                                                                                                                                                                                                  
   users = ["john" "alice"];                                                                                                                                                                                       
   rootless = true;                                                                                                                                                                                                
 };                                                                                                                                                                                                                
 ```                                                                                                                                                                                                               
                                                                                                                                                                                                                   
 ---                                                                                                                                                                                                               
                                                                                                                                                                                                                   
 ### 2.2 Convert `syncthing.nix` to mkEnableOption Pattern                                                                                                                                                         
                                                                                                                                                                                                                   
 **Problem**: Hardcoded user and paths, no configuration options.                                                                                                                                                  
                                                                                                                                                                                                                   
 **Solution**: Converted to proper NixOS module with configurable options.                                                                                                                                         
                                                                                                                                                                                                                   
 **Changes Made**:                                                                                                                                                                                                 
 - Added `options.modules.syncthing` with:                                                                                                                                                                         
   - `enable` - mkEnableOption                                                                                                                                                                                     
   - `user` - User to run Syncthing as                                                                                                                                                                             
   - `dataDir` - Directory for Syncthing data                                                                                                                                                                      
   - `configDir` - Directory for Syncthing configuration                                                                                                                                                           
   - `openDefaultPorts` - Open firewall ports (default: true)                                                                                                                                                      
   - `guiUser` / `guiPassword` - Optional GUI authentication                                                                                                                                                       
                                                                                                                                                                                                                   
 **Usage**:                                                                                                                                                                                                        
 ```nix                                                                                                                                                                                                            
 modules.syncthing = {                                                                                                                                                                                             
   enable = true;                                                                                                                                                                                                  
   user = "john";                                                                                                                                                                                                  
   dataDir = "/home/john/Pictures/Syncthing";                                                                                                                                                                      
   configDir = "/home/john/.config/syncthing";                                                                                                                                                                     
 };                                                                                                                                                                                                                
 ```                                                                                                                                                                                                               
                                                                                                                                                                                                                   
 ---                                                                                                                                                                                                               
                                                                                                                                                                                                                   
 ### 2.3 Convert `virtualisation.nix` to mkEnableOption Pattern                                                                                                                                                    
                                                                                                                                                                                                                   
 **Problem**: Hardcoded user in libvirtd group, no feature toggles.                                                                                                                                                
                                                                                                                                                                                                                   
 **Solution**: Converted to proper NixOS module with granular options.                                                                                                                                             
                                                                                                                                                                                                                   
 **Changes Made**:                                                                                                                                                                                                 
 - Added `options.modules.virtualisation` with:                                                                                                                                                                    
   - `enable` - mkEnableOption                                                                                                                                                                                     
   - `users` - List of users to add to libvirtd group                                                                                                                                                              
   - `enableTPM` - Enable TPM emulation (default: true)                                                                                                                                                            
   - `enableSpice` - Enable SPICE guest tools (default: true)                                                                                                                                                      
   - `enableUSBRedirection` - Enable USB redirection (default: true)                                                                                                                                               
   - `trustedInterfaces` - Network interfaces to trust (default: ["virbr0"])                                                                                                                                       
                                                                                                                                                                                                                   
 **Usage**:                                                                                                                                                                                                        
 ```nix                                                                                                                                                                                                            
 modules.virtualisation = {                                                                                                                                                                                        
   enable = true;                                                                                                                                                                                                  
   users = ["john"];                                                                                                                                                                                               
   enableTPM = true;                                                                                                                                                                                               
   enableSpice = true;                                                                                                                                                                                             
 };                                                                                                                                                                                                                
 ```                                                                                                                                                                                                               
                                                                                                                                                                                                                   
 ---                                                                                                                                                                                                               
                                                                                                                                                                                                                   
 ### 2.4 Convert `1password.nix` to mkEnableOption Pattern                                                                                                                                                         
                                                                                                                                                                                                                   
 **Problem**: Hardcoded polkit policy owner, no option to disable CLI or GUI separately.                                                                                                                           
                                                                                                                                                                                                                   
 **Solution**: Converted to proper NixOS module with separate toggles.                                                                                                                                             
                                                                                                                                                                                                                   
 **Changes Made**:                                                                                                                                                                                                 
 - Added `options.modules._1password` with:                                                                                                                                                                        
   - `enable` - mkEnableOption                                                                                                                                                                                     
   - `enableCLI` - Enable 1Password CLI (default: true)                                                                                                                                                            
   - `enableGUI` - Enable 1Password GUI (default: true)                                                                                                                                                            
   - `polkitPolicyOwners` - List of users authorized for polkit                                                                                                                                                    
                                                                                                                                                                                                                   
 **Usage**:                                                                                                                                                                                                        
 ```nix                                                                                                                                                                                                            
 modules._1password = {                                                                                                                                                                                            
   enable = true;                                                                                                                                                                                                  
   polkitPolicyOwners = ["john" "kiran"];                                                                                                                                                                          
 };                                                                                                                                                                                                                
 ```                                                                                                                                                                                                               
                                                                                                                                                                                                                   
 ---                                                                                                                                                                                                               
                                                                                                                                                                                                                   
 ### 2.5 Convert `steam.nix` to mkEnableOption Pattern                                                                                                                                                             
                                                                                                                                                                                                                   
 **Problem**: All gaming packages installed unconditionally, no way to customize.                                                                                                                                  
                                                                                                                                                                                                                   
 **Solution**: Converted to proper NixOS module with feature toggles.                                                                                                                                              
                                                                                                                                                                                                                   
 **Changes Made**:                                                                                                                                                                                                 
 - Added `options.modules.steam` with:                                                                                                                                                                             
   - `enable` - mkEnableOption                                                                                                                                                                                     
   - `remotePlay` - Open firewall for Remote Play (default: true)                                                                                                                                                  
   - `dedicatedServer` - Open firewall for dedicated servers (default: true)                                                                                                                                       
   - `localNetworkGameTransfers` - Open firewall for LAN transfers (default: true)                                                                                                                                 
   - `enableWine` - Install Wine packages (default: true)                                                                                                                                                          
   - `enableGameMode` - Install gamemode/mangohud (default: true)                                                                                                                                                  
 - Packages conditionally installed based on options                                                                                                                                                               
                                                                                                                                                                                                                   
 **Usage**:                                                                                                                                                                                                        
 ```nix                                                                                                                                                                                                            
 modules.steam = {                                                                                                                                                                                                 
   enable = true;                                                                                                                                                                                                  
   enableWine = false;  # Skip Wine if not needed                                                                                                                                                                  
   enableGameMode = true;                                                                                                                                                                                          
 };                                                                                                                                                                                                                
 ```                                                                                                                                                                                                               
                                                                                                                                                                                                                   
 ---                                                                                                                                                                                                               
                                                                                                                                                                                                                   
 ## Phase 3 - Feature Flags & Profiles                                                                                                                                                                             
                                                                                                                                                                                                                   
 ### 3.1 Host-Level Feature Flags (`hosts/common/options.nix`)                                                                                                                                                     
                                                                                                                                                                                                                   
 **Problem**: Features toggled via commenting/uncommenting imports, error-prone and unclear.                                                                                                                       
                                                                                                                                                                                                                   
 **Solution**: Created declarative feature flag system.                                                                                                                                                            
                                                                                                                                                                                                                   
 **Changes Made**:                                                                                                                                                                                                 
 - Created `hosts/common/options.nix` with `options.host` containing:                                                                                                                                              
   - `username` - Primary username for the host (default: "john")                                                                                                                                                  
   - `features.gaming` - Enable gaming support                                                                                                                                                                     
   - `features.development` - Enable development tools                                                                                                                                                             
   - `features.virtualization` - Enable virtualization                                                                                                                                                             
   - `features.desktop` - Enable desktop environment                                                                                                                                                               
   - `features.server` - Enable server configuration                                                                                                                                                               
   - `features.printing` - Enable printing support                                                                                                                                                                 
   - `features.flatpak` - Enable Flatpak                                                                                                                                                                           
   - `features.yubikey` - Enable YubiKey support                                                                                                                                                                   
                                                                                                                                                                                                                   
 **Usage**:                                                                                                                                                                                                        
 ```nix                                                                                                                                                                                                            
 host.username = "john";                                                                                                                                                                                           
 host.features = {                                                                                                                                                                                                 
   gaming = true;                                                                                                                                                                                                  
   development = true;                                                                                                                                                                                             
   virtualization = true;                                                                                                                                                                                          
   desktop = true;                                                                                                                                                                                                 
 };                                                                                                                                                                                                                
 ```                                                                                                                                                                                                               
                                                                                                                                                                                                                   
 ---                                                                                                                                                                                                               
                                                                                                                                                                                                                   
 ### 3.2 Feature Aggregator (`hosts/common/features.nix`)                                                                                                                                                          
                                                                                                                                                                                                                   
 **Problem**: No central place to wire feature flags to module configurations.                                                                                                                                     
                                                                                                                                                                                                                   
 **Solution**: Created aggregator that imports modules and configures them based on flags.                                                                                                                         
                                                                                                                                                                                                                   
 **Changes Made**:                                                                                                                                                                                                 
 - Created `hosts/common/features.nix` that:                                                                                                                                                                       
   - Imports `options.nix` and all converted optional modules                                                                                                                                                      
   - Automatically enables `modules.steam` when `host.features.gaming` is true                                                                                                                                     
   - Automatically enables `modules.docker` when `host.features.development` is true                                                                                                                               
   - Automatically enables `modules.virtualisation` when `host.features.virtualization` is true                                                                                                                    
   - Automatically enables `modules._1password` when `host.features.desktop` is true                                                                                                                               
   - Uses `host.username` to configure user-specific settings                                                                                                                                                      
                                                                                                                                                                                                                   
 **Usage**:                                                                                                                                                                                                        
 ```nix                                                                                                                                                                                                            
 imports = [ ../common/features.nix ];                                                                                                                                                                             
                                                                                                                                                                                                                   
 host.username = "john";                                                                                                                                                                                           
 host.features.gaming = true;                                                                                                                                                                                      
 # Steam is now automatically configured for user "john"                                                                                                                                                           
 ```                                                                                                                                                                                                               
                                                                                                                                                                                                                   
 ---                                                                                                                                                                                                               
                                                                                                                                                                                                                   
 ### 3.3 Profile System (`profiles/`)                                                                                                                                                                              
                                                                                                                                                                                                                   
 **Problem**: No way to bundle related features for different use cases.                                                                                                                                           
                                                                                                                                                                                                                   
 **Solution**: Created profiles directory with preset configurations.                                                                                                                                              
                                                                                                                                                                                                                   
 **Changes Made**:                                                                                                                                                                                                 
 - Created `profiles/server.nix` as example profile:                                                                                                                                                               
   - Imports core configuration and features system                                                                                                                                                                
   - Sets appropriate feature flags for a server (no gaming, no desktop)                                                                                                                                           
   - Enables SSH with secure defaults                                                                                                                                                                              
   - Provides template for other profiles (desktop, workstation, gaming)                                                                                                                                           
                                                                                                                                                                                                                   
 **Planned Profiles** (can be added as needed):                                                                                                                                                                    
 - `profiles/minimal.nix` - Base system only                                                                                                                                                                       
 - `profiles/desktop.nix` - Standard desktop                                                                                                                                                                       
 - `profiles/workstation.nix` - Development workstation                                                                                                                                                            
 - `profiles/gaming.nix` - Gaming-optimized                                                                                                                                                                        
                                                                                                                                                                                                                   
 **Usage**:                                                                                                                                                                                                        
 ```nix                                                                                                                                                                                                            
 imports = [ ../../profiles/server.nix ];                                                                                                                                                                          
 # All server-appropriate features are now configured                                                                                                                                                              
 ```                                                                                                                                                                                                               
                                                                                                                                                                                                                   
 ---                                                                                                                                                                                                               
                                                                                                                                                                                                                   
 ## Phase 4 - Polish                                                                                                                                                                                               
                                                                                                                                                                                                                   
 ### 4.1 Flake Module Exports                                                                                                                                                                                      
                                                                                                                                                                                                                   
 **Problem**: No way to reuse modules externally or in other flakes.                                                                                                                                               
                                                                                                                                                                                                                   
 **Solution**: Added module exports to `flake.nix`.                                                                                                                                                                
                                                                                                                                                                                                                   
 **Changes Made**:                                                                                                                                                                                                 
 - Added `nixosModules` output with all optional modules:                                                                                                                                                          
   - `docker`, `syncthing`, `virtualisation`, `_1password`, `steam`                                                                                                                                                
   - `flatpak`, `printing`, `niri`, `tlp`, `fwupd`                                                                                                                                                                 
   - `core`, `options`, `features`                                                                                                                                                                                 
   - `profiles` (nested: minimal, desktop, workstation, gaming, server)                                                                                                                                            
 - Added `homeManagerModules` output:                                                                                                                                                                              
   - `devTools`, `gaming`, `regularPrograms`, `workApplications`                                                                                                                                                   
   - `vmTools`, `obsStudio`, `plasmaManager`                                                                                                                                                                       
                                                                                                                                                                                                                   
 **Usage** (in another flake):                                                                                                                                                                                     
 ```nix                                                                                                                                                                                                            
 {                                                                                                                                                                                                                 
   inputs.my-nixos-config.url = "github:user/nixos-config";                                                                                                                                                        
                                                                                                                                                                                                                   
   outputs = { my-nixos-config, ... }: {                                                                                                                                                                           
     nixosConfigurations.myhost = nixpkgs.lib.nixosSystem {                                                                                                                                                        
       modules = [                                                                                                                                                                                                 
         my-nixos-config.nixosModules.docker                                                                                                                                                                       
         { modules.docker.enable = true; }                                                                                                                                                                         
       ];                                                                                                                                                                                                          
     };                                                                                                                                                                                                            
   };                                                                                                                                                                                                              
 }                                                                                                                                                                                                                 
 ```                                                                                                                                                                                                               
                                                                                                                                                                                                                   
 ---                                                                                                                                                                                                               
                                                                                                                                                                                                                   
 ### 4.2 Shared Home Manager Modules (`home/common/optional/`)                                                                                                                                                     
                                                                                                                                                                                                                   
 **Problem**: `home/kiran/john-sony-laptop.nix` imports from `../john/optional/` via path traversal, creating tight coupling.                                                                                      
                                                                                                                                                                                                                   
 **Solution**: Created shared modules directory for truly common configurations.                                                                                                                                   
                                                                                                                                                                                                                   
 **Changes Made**:                                                                                                                                                                                                 
 - Created `home/common/optional/regular-programs.nix` with common desktop applications:                                                                                                                           
   - Office: libreoffice, hunspell                                                                                                                                                                                 
   - Media: vlc, audacious                                                                                                                                                                                         
   - Utilities: btop, htop, eza, jq, etc.                                                                                                                                                                          
   - Browsers: firefox, google-chrome                                                                                                                                                                              
   - Communication: slack, zoom                                                                                                                                                                                    
 - Updated `home/kiran/john-sony-laptop.nix` to import from `../common/optional/` instead of `../john/optional/`                                                                                                   
                                                                                                                                                                                                                   
 **Before**:                                                                                                                                                                                                       
 ```nix                                                                                                                                                                                                            
 imports = [ ../john/optional/regular-programs.nix ];  # Cross-user import                                                                                                                                         
 ```                                                                                                                                                                                                               
                                                                                                                                                                                                                   
 **After**:                                                                                                                                                                                                        
 ```nix                                                                                                                                                                                                            
 imports = [ ../common/optional/regular-programs.nix ];  # Shared module                                                                                                                                           
 ```                                                                                                                                                                                                               
                                                                                                                                                                                                                   
 ---                                                                                                                                                                                                               
                                                                                                                                                                                                                   
 ### 4.3 Flake Checks                                                                                                                                                                                              
                                                                                                                                                                                                                   
 **Problem**: No automated validation before deployment.                                                                                                                                                           
                                                                                                                                                                                                                   
 **Solution**: Added `checks` output to `flake.nix`.                                                                                                                                                               
                                                                                                                                                                                                                   
 **Changes Made**:                                                                                                                                                                                                 
 - Added `checks.x86_64-linux` with:                                                                                                                                                                               
   - `vm` - Verify VM configuration builds                                                                                                                                                                         
   - `john-laptop` - Verify john-laptop configuration builds                                                                                                                                                       
   - `john-sony-laptop` - Verify john-sony-laptop configuration builds                                                                                                                                             
   - `formatting` - Verify all files are properly formatted with alejandra                                                                                                                                         
                                                                                                                                                                                                                   
 **Usage**:                                                                                                                                                                                                        
 ```bash                                                                                                                                                                                                           
 # Run all checks                                                                                                                                                                                                  
 nix flake check                                                                                                                                                                                                   
                                                                                                                                                                                                                   
 # Build specific check                                                                                                                                                                                            
 nix build .#checks.x86_64-linux.john-laptop                                                                                                                                                                       
 ```                                                                                                                                                                                                               
                                                                                                                                                                                                                   
 ---                                                                                                                                                                                                               
                                                                                                                                                                                                                   
 ### 4.4 Host Configuration Updates                                                                                                                                                                                
                                                                                                                                                                                                                   
 **Problem**: Host configurations using old import-based pattern.                                                                                                                                                  
                                                                                                                                                                                                                   
 **Solution**: Updated all host configurations to use new module options.                                                                                                                                          
                                                                                                                                                                                                                   
 **Changes Made**:                                                                                                                                                                                                 
 - Updated `hosts/john-laptop/default.nix`:                                                                                                                                                                        
   - Imports converted modules                                                                                                                                                                                     
   - Uses `modules.*` options to configure features                                                                                                                                                                
   - Removed inline overlays (now uses `overlays/`)                                                                                                                                                                
 - Updated `hosts/john-sony-laptop/default.nix`:                                                                                                                                                                   
   - Same pattern, with modules disabled that aren't needed                                                                                                                                                        
 - Updated `hosts/nixos-anywhere-vm/default.nix`:                                                                                                                                                                  
   - Same pattern, VM-appropriate settings                                                                                                                                                                         
 - Fixed `hosts/common/core/configuration.nix`:                                                                                                                                                                    
   - Changed `services.timesyncd.enable = true` to `lib.mkDefault true` to allow VM override                                                                                                                       
                                                                                                                                                                                                                   
 ---                                                                                                                                                                                                               
                                                                                                                                                                                                                   
 ## Files Summary                                                                                                                                                                                                  
                                                                                                                                                                                                                   
 ### New Files Created                                                                                                                                                                                             
 | File | Purpose |                                                                                                                                                                                                
 |------|---------|                                                                                                                                                                                                
 | `lib/default.nix` | Helper functions library |                                                                                                                                                                  
 | `overlays/default.nix` | Overlay aggregator |                                                                                                                                                                   
 | `overlays/tailscale.nix` | Tailscale test skip overlay |                                                                                                                                                        
 | `overlays/easytag.nix` | Easytag id3lib fix overlay |                                                                                                                                                           
 | `profiles/server.nix` | Server profile preset |                                                                                                                                                                 
 | `hosts/common/options.nix` | Feature flag definitions |                                                                                                                                                         
 | `hosts/common/features.nix` | Feature aggregator |                                                                                                                                                              
 | `home/common/optional/regular-programs.nix` | Shared home programs |                                                                                                                                            
 | `.pre-commit-config.yaml` | Pre-commit hook configuration |                                                                                                                                                     
                                                                                                                                                                                                                   
 ### Files Modified                                                                                                                                                                                                
 | File | Changes |                                                                                                                                                                                                
 |------|---------|                                                                                                                                                                                                
 | `flake.nix` | Added devShells, lib, overlays, nixosModules, homeManagerModules, checks |                                                                                                                        
 | `hosts/john-laptop/default.nix` | Use module options, import overlays directory |                                                                                                                               
 | `hosts/john-sony-laptop/default.nix` | Use module options |                                                                                                                                                     
 | `hosts/nixos-anywhere-vm/default.nix` | Use module options |                                                                                                                                                    
 | `hosts/common/optional/docker.nix` | Converted to mkEnableOption |                                                                                                                                              
 | `hosts/common/optional/syncthing.nix` | Converted to mkEnableOption |                                                                                                                                           
 | `hosts/common/optional/virtualisation.nix` | Converted to mkEnableOption |                                                                                                                                      
 | `hosts/common/optional/1password.nix` | Converted to mkEnableOption |                                                                                                                                           
 | `hosts/common/optional/steam.nix` | Converted to mkEnableOption |                                                                                                                                               
 | `hosts/common/core/configuration.nix` | mkDefault for timesyncd |                                                                                                                                               
 | `home/kiran/john-sony-laptop.nix` | Import from common instead of john |                                                                                                                                        
                                                                                                                                                                                                                   
 ---                                                                                                                                                                                                               
                                                                                                                                                                                                                   
 ## Verification Commands                                                                                                                                                                                          
                                                                                                                                                                                                                   
 ```bash                                                                                                                                                                                                           
 # Check flake for errors                                                                                                                                                                                          
 nix flake check                                                                                                                                                                                                   
                                                                                                                                                                                                                   
 # Format all files                                                                                                                                                                                                
 nix fmt                                                                                                                                                                                                           
                                                                                                                                                                                                                   
 # Enter development shell                                                                                                                                                                                         
 nix develop                                                                                                                                                                                                       
                                                                                                                                                                                                                   
 # Build and test VM                                                                                                                                                                                               
 nix build .#nixosConfigurations.vm.config.system.build.vm                                                                                                                                                         
 ./result/bin/run-nixos-vm                                                                                                                                                                                         
                                                                                                                                                                                                                   
 # Deploy to host                                                                                                                                                                                                  
 sudo nixos-rebuild switch --flake .#john-laptop                                                                                                                                                                   
                                                                                                                                                                                                                   
 # Run linters manually                                                                                                                                                                                            
 statix check .                                                                                                                                                                                                    
 deadnix .                                                                                                                                                                                                         
 ```                                                                                                                                                                                                               
                                                                                                                                                                                                                   
 ---                                                                                                                                                                                                               
                                                                                                                                                                                                                   
 ## Future Improvements                                                                                                                                                                                            
                                                                                                                                                                                                                   
 | Topic | Description | When to Consider |                                                                                                                                                                        
 |-------|-------------|------------------|                                                                                                                                                                        
 | **flake-parts** | Modular flake organization | When flake.nix becomes unwieldy |                                                                                                                                
 | **impermanence** | Declarative filesystem state | For ultra-reproducible systems |                                                                                                                              
 | **deploy-rs** | Remote deployment with rollback | When managing remote hosts |                                                                                                                                  
 | **More profiles** | desktop, workstation, gaming profiles | As usage patterns emerge |                                                                                                                          
 | **Module tests** | NixOS VM tests for modules | For CI/CD validation |  